const margin={top:50,right:15,bottom:70,left:55};let map,histogram,histogramData,width=document.getElementById("vis").offsetWidth-margin.left-margin.right-20,height=document.getElementById("vis").offsetHeight-margin.top-margin.bottom,currentHistogram=-1,layers={};const ANIMATION_LENGTH=300,ANIMATION_STEP=10,colors={white:"#f9f9f9",blue:"#1f3a93",black:"#2e3131",green:"#1e824c",red:"#cf000f",yellow:"#eeee00"};var scrollVis=function(){//TODO await
function a(a){let b=0,c=setInterval(function(){layers.kcShotSpotterActivations.isVisible||layers.kcShotSpotterActivations.setStyle({fillOpacity:.5*(b/ANIMATION_LENGTH),opacity:b/ANIMATION_LENGTH}),layers.kcShotSpotterActivations.eachLayer(function(c){let d;d=a?2*Math.max(Math.sqrt(b/ANIMATION_LENGTH*c.feature.properties.Activations),1):2*Math.max(Math.sqrt((1-b/ANIMATION_LENGTH)*c.feature.properties.Activations),1),a&&!layers.kcShotSpotterActivations.isScaled?c.setRadius(d):!a&&layers.kcShotSpotterActivations.isScaled&&c.setRadius(d)}),b>=ANIMATION_LENGTH&&(clearInterval(c),layers.kcShotSpotterActivations.isVisible=!0,layers.kcShotSpotterActivations.isScaled=a),b+=ANIMATION_STEP},ANIMATION_STEP)}function b(){let a=0,b=setInterval(function(){layers.kcShotSpotterActivations.isVisible&&layers.kcShotSpotterActivations.setStyle({fillOpacity:.5-.5*(a/ANIMATION_LENGTH),opacity:1-a/ANIMATION_LENGTH}),a>=ANIMATION_LENGTH&&(clearInterval(b),layers.kcShotSpotterActivations.isVisible=!1),a+=ANIMATION_STEP},ANIMATION_STEP)}function c(a,b,c,d,e,f){// Update map
let g=d3.scaleLinear().domain(a).range(b);layers.kcBGsWithData.setStyle(function(a){return{color:a.properties[c]?g(a.properties[c]):"rgba(0, 0, 0, 0)"}}),layers.kcBGsWithData.setStyle({fillOpacity:1}),d3.select("#chloropleth-legend").style("opacity","1"),d3.select("#color-scale").html(""),d3.select("#chloropleth-title").text(d);const h=a[0],i=a[a.length-1],j=(i-h)/(5-(f?1:0));for(let k,l=0;l<5;l++)k=d3.select("#color-scale").append("div"),k.append("div").attr("class","legend-item").style("background",g(h+l*j)),k.append("span").text(e(h+l*j))}function d(){layers.kcBGsWithData.setStyle({fillOpacity:0}),d3.select("#chloropleth-legend").style("opacity","0")}function e(a){a.setStyle({fillOpacity:1,opacity:1})}function f(a){a.setStyle({fillOpacity:0,opacity:0})}function g(){d3.select("#chloropleth-legend").style("opacity","1"),d3.select("#color-scale").html(""),d3.select("#chloropleth-title").text("ShotSpotter activations"),[1,24,48].forEach(function(a,b){let c=2*Math.sqrt(a),d=2*Math.sqrt(48)-c,e=d3.select("#color-scale").append("div").attr("class","level").style("margin-bottom",(2==b?0:c/2)+"px").style("margin-left",d+"px").append("div").attr("class","level-left");e.append("div").attr("class","legend-item level-item").style("border-radius","100%").style("border","1px solid rgba(46, 48, 48, 0.5)").style("background-color","rgba(207, 0, 15)").style("width",2*c+"px").style("height",2*c+"px").style("margin-right",d+5+"px"),e.append("span").text(a)})}/**
   * activate -
   *
   * @param index - index of the activated section
   */ // Which visualization we currently are on
var h=-1,i=0,j=[],k=[],l=function(a){a.each(function(a){m(a),n(a)})},m=function(a){map=L.map("map",{zoomControl:!1,scrollWheelZoom:!1,doubleClickZoom:!1,dragging:!1});var b=L.canvas();// Initialize geoJSON layers
for(let c in a.layers){let d={};// Styling options
// Render based off point or polygon
"kcBoundaries"==c?d={color:colors.black,weight:2,opacity:.7,fillOpacity:0}:"kcBGsWithData"===c?d={weight:0,transition:"0.3s all"}:"kcMaxBusLines"===c||"troostAve"===c?d={color:colors.blue,weight:3}:"kccc39"===c?d={color:colors.black,weight:2}:"kcShotSpotterApproxCoverageArea"===c?d={color:colors.red,weight:2,opacity:.7,fillOpacity:0}:"kcShotSpotterActivations"===c?d={radius:2,fillColor:colors.red,color:colors.black,weight:.5,opacity:1,fillOpacity:.5,renderer:b}:"kcUrbanRenewalAreas"===c||"kcccFocus"===c?d={radius:4,fillColor:colors.black,weight:0,opacity:1,fillOpacity:1}:void 0,"kcBoundaries"==c||"kcBGsWithData"===c||"kcMaxBusLines"===c||"troostAve"===c||"kccc39"===c||"kcShotSpotterApproxCoverageArea"===c?layers[c]=L.geoJSON(a.layers[c],{style:d}):"kcUrbanRenewalAreas"===c||"kcShotSpotterActivations"===c?layers[c]=L.geoJSON(a.layers[c],{pointToLayer:function(a,b){return L.circleMarker(b,d)}}):"kcccFocus"===c?layers[c]=L.geoJSON(a.layers[c],{pointToLayer:function(a,b){return L.circleMarker(b,d).bindTooltip(a.properties.label,{permanent:!0,direction:"31st & Troost"==a.properties.label?"left":"right"})}}):void 0,layers[c].addTo(map),"kcShotSpotterApproxCoverageArea"==c||"kcBoundaries"==c||layers[c].setStyle({opacity:0,fillOpacity:0})}// Fit
map.fitBounds(layers.kcBoundaries.getBounds()),layers.kcShotSpotterActivations.isScaled=!1,layers.kcShotSpotterActivations.isVisible=!1,d(),layers.kccc39.bindTooltip("39th Street Corridor",{permanent:!0,direction:"left",offset:L.point([-50,0])}),layers.troostAve.bindTooltip("Troost Ave",{permanent:!0,direction:"left"}),L.tileLayer("https://api.maptiler.com/maps/positron/{z}/{x}/{y}.png?key=lTdR1t9ghN06990FNZFA",{attribution:"<a href=\"https://www.maptiler.com/copyright/\" target=\"_blank\">&copy; MapTiler</a> <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">&copy; OpenStreetMap contributors</a>"}).addTo(map),d3.select("#loading").style("display","none"),d3.select("#map").style("visibility","visible"),d3.select("#legend").style("visibility","visible")},n=function(h){j[0]=function(){map.flyToBounds(layers.kcBoundaries.getBounds())},k[0]=function(){},j[1]=function(){map.flyToBounds(layers.kcShotSpotterApproxCoverageArea.getBounds(),{padding:[5,5]}),b(),d3.select("#legend-3").style("display","none")},k[1]=function(){},j[2]=function(){a(!1),d3.select("#legend-3").style("display","inline-block"),d3.select("#chloropleth-legend").style("opacity","0")},k[2]=function(){},j[3]=function(){a(!0),g()},k[3]=function(){},j[4]=function(){},k[4]=function(){},j[5]=function(){},k[5]=function(){},j[6]=function(){},k[6]=function(){},j[7]=function(){d(),g(),map.flyToBounds(layers.kcShotSpotterApproxCoverageArea.getBounds(),{padding:[5,5]}),a(!0)},k[7]=function(){},j[8]=function(){d3.select("#legend-3").style("display","none"),map.flyToBounds(layers.kcBoundaries.getBounds()),b(),c([0,h.maxViolentCrimeRate],[colors.white,colors.black],"VIOLENT CRIME RATE","Violent Crime per 1k People",a=>Math.round(1e3*a))},k[8]=function(){},j[9]=function(){map.flyToBounds([[39.152465,-94.609998],[39.018955,-94.509757]]),c([0,h.maxViolentCrimeRate],[colors.white,colors.black],"VIOLENT CRIME RATE","Violent Crime per 1k People",a=>Math.round(1e3*a))},k[9]=function(){},j[10]=function(){c([0,h.maxViolentCrimeRate],[colors.white,colors.black],"VIOLENT CRIME RATE","Violent Crime per 1k People",a=>Math.round(1e3*a)),layers.kcBGsWithData.eachLayer(function(a){"290950034002"==a.feature.properties.GEOID&&a.setStyle({color:colors.yellow})})},k[10]=function(){},j[11]=function(){d(),d3.select("#legend-4").style("display","none"),f(layers.kcMaxBusLines)},k[11]=function(){},j[12]=function(){d3.select("#legend-4").style("display","inline-block"),e(layers.kcMaxBusLines),layers.kcShotSpotterApproxCoverageArea.bringToFront(),f(layers.troostAve)},k[12]=function(){},j[13]=function(){f(layers.kcMaxBusLines),d3.select("#legend-4").style("display","none"),e(layers.troostAve),layers.kcShotSpotterApproxCoverageArea.bringToFront()},k[13]=function(){},j[14]=function(){d()},k[14]=function(){},j[15]=function(){c([0,1],[colors.white,colors.blue],"PCT_BLACK","Percent Black",a=>Math.round(100*a)+"%")},k[15]=function(){},j[16]=function(){f(layers.kcUrbanRenewalAreas),c([0,1],[colors.white,colors.blue],"PCT_BLACK","Percent Black",a=>Math.round(100*a)+"%"),d3.select("#legend-5").style("display","none")},k[16]=function(){},j[17]=function(){d(),d3.select("#legend-5").style("display","inline-block"),e(layers.kcUrbanRenewalAreas),f(layers.kcccFocus),f(layers.kccc39)},k[17]=function(){},j[18]=function(){e(layers.kccc39),e(layers.kcccFocus)},k[18]=function(){},j[19]=function(){d(),e(layers.kcccFocus),e(layers.kcUrbanRenewalAreas),e(layers.troostAve),e(layers.kccc39),d3.select("#legend-5").style("display","inline-block")},k[19]=function(){},j[20]=function(){d3.select("#legend-5").style("display","none"),f(layers.kcccFocus),f(layers.kcUrbanRenewalAreas),f(layers.troostAve),f(layers.kccc39),c([-1.5,0,1.5],[colors.blue,colors.white,colors.red],"PCT_CHANGE_RENT","Pct. Change Median Gross Rent",a=>Math.round(100*a)+"%",!0)},k[20]=function(){},j[21]=function(){c([0,25],[colors.white,colors.red],"eviction.rate","Eviction Rate",a=>Math.round(a)+"%")},k[21]=function(){},j[22]=function(){c([-.5,0,.5],[colors.red,colors.white,colors.blue],"PCT_CHANGE_BLACK","Pct. Change Black Population",a=>Math.round(100*a)+"%",!0)},k[22]=function(){},j[23]=function(){},k[23]=function(){},j[24]=function(){},k[24]=function(){}};// return chart function
return l.activate=function(a){i=a;var b=0>i-h?-1:1,c=d3.range(h+b,i+b,b);c.forEach(function(a){j[a]()}),h=i},l.update=function(a,b){k[a](b)},l};// Load all files, then display
Promise.all([d3.json("data/public/kansas-city-bgs.geojson"),d3.json("data/public/kansas-city-boundaries-mo.geojson"),d3.json("data/public/kansas-city-max-buslines.geojson"),d3.json("data/public/kansas-city-shotspotter-activations-grouped.geojson"),d3.json("data/public/kansas-city-shotspotter-approx-coverage-area.geojson"),d3.json("data/public/kansas-city-urban-renewal-areas.geojson"),d3.json("data/public/troost-ave.geojson"),d3.json("data/public/kccc-39.geojson"),d3.json("data/public/kccc-areas.geojson")]).then(function(a){// Process data
let b={kcBGsWithData:a[0],kcBoundaries:a[1],kcMaxBusLines:a[2],kcShotSpotterActivations:a[3],kcShotSpotterApproxCoverageArea:a[4],kcUrbanRenewalAreas:a[5],troostAve:a[6],kccc39:a[7],kcccFocus:a[8]},c=0;// Cast to real
return b.kcBGsWithData.features=b.kcBGsWithData.features.map(function(a){return["2013 MEDIAN GROSS RENT","2013 PCT BLACK","2013 PCT HISPANIC","2013 PCT WHITE","2019 MEDIAN GROSS RENT","PCT_BLACK","PCT_HISPANIC","PCT_WHITE","TOTAL"].forEach(function(b){a.properties[b]=parseFloat(a.properties[b]),c=Math.max(c,a.properties["VIOLENT CRIME RATE"])}),a}),{maxViolentCrimeRate:c,layers:b}}).then(function(a){var b=scrollVis();d3.select("#vis").datum(a).call(b);var c=scroller().container(d3.select("#scrolling-vis"));// TODO: remove
c(d3.selectAll(".step")),c.on("active",function(a){d3.selectAll(".step").classed("active",function(b,c){return c===a}).style("opacity",function(b,c){return c===a?1:.1}),b.activate(a)}),c.on("progress",function(a,c){b.update(a,c)})}).catch(function(a){// handle error here
console.log(a)});
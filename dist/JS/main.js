const margin={top:50,right:15,bottom:70,left:55};let map,histogram,histogramData,width=document.getElementById("vis").offsetWidth-margin.left-margin.right-20,height=document.getElementById("vis").offsetHeight-margin.top-margin.bottom,currentHistogram=-1,layers={};const colors={white:"#f9f9f9",blue:"#1f3a93",black:"#2e3131",green:"#1e824c",red:"#cf000f",yellow:"#eeee00"};var scrollVis=function(){function a(a,b,c,d,e,f){// Update map
let g=d3.scaleLinear().domain(a).range(b);layers.kcBGsWithData.setStyle(function(a){return{color:a.properties[c]?g(a.properties[c]):"rgba(0, 0, 0, 0)"}}),layers.kcBGsWithData.setStyle({fillOpacity:1,opacity:1}),d3.select("#chloropleth-legend").style("display","block"),d3.select("#color-scale").html(""),d3.select("#chloropleth-title").text(d);const h=a[0],i=a[a.length-1],j=(i-h)/(5-(f?1:0));for(let k,l=0;l<5;l++)k=d3.select("#color-scale").append("div"),k.append("div").attr("class","legend-item").style("background",g(h+l*j)),k.append("span").text(e(h+l*j))}function b(){layers.kcBGsWithData.setStyle({fillOpacity:0,opacity:0}),d3.select("#chloropleth-legend").style("display","none")}function c(){d3.select("#chloropleth-legend").style("display","block"),d3.select("#color-scale").html(""),d3.select("#chloropleth-title").text("ShotSpotter activations"),[1,24,48].forEach(function(a,b){let c=2*Math.sqrt(a),d=2*Math.sqrt(48)-c,e=d3.select("#color-scale").append("div").attr("class","level").style("margin-bottom",(2==b?0:c/2)+"px").style("margin-left",d+"px").append("div").attr("class","level-left");e.append("div").attr("class","legend-item level-item").style("border-radius","100%").style("border","1px solid rgba(46, 48, 48, 0.5)").style("background-color","rgba(207, 0, 15)").style("width",2*c+"px").style("height",2*c+"px").style("margin-right",d+5+"px"),e.append("span").text(a)})}/**
   * activate -
   *
   * @param index - index of the activated section
   */ // Which visualization we currently are on
var d=-1,e=0,f=[],g=[],h=function(a){a.each(function(a){i(a),j(a)})},i=function(a){// Initialize geoJSON layers
for(let b in map=L.map("map",{zoomControl:!1,scrollWheelZoom:!1,doubleClickZoom:!1,dragging:!1}),a){let c={};// Styling options
"kcBoundaries"==b?c={color:colors.black,weight:2,opacity:.7,fillOpacity:0}:"kcMaxBusLines"===b?c={color:colors.blue,weight:3}:"kccc39"===b?c={color:colors.green,weight:3}:"kcShotSpotterApproxCoverageArea"===b?c={color:colors.red,weight:2,opacity:.7,fillOpacity:0}:"kcShotspotterActivations"===b?c={radius:2,fillColor:colors.red,color:colors.black,weight:.5,opacity:.5,fillOpacity:1}:"kcUrbanRenewalAreas"===b?c={radius:4,fillColor:colors.black,weight:0,opacity:1,fillOpacity:1}:void 0,"kcBoundaries"==b||"kcBGsWithData"===b||"kcMaxBusLines"===b||"troostAve"===b||"kccc39"===b||"kcShotSpotterApproxCoverageArea"===b?layers[b]=L.geoJSON(a[b],{style:c}):"kcEvictions"===b||"kcUrbanRenewalAreas"===b||"kcShotspotterActivations"===b?layers[b]=L.geoJSON(a[b],{pointToLayer:function(a,b){return L.circleMarker(b,c)}}):void 0}// Fit
map.fitBounds(layers.kcBoundaries.getBounds()),layers.kcShotspotterActivations.addTo(map),layers.kcBGsWithData.addTo(map),layers.kcShotspotterActivations.setStyle({fillOpacity:0,opacity:0}),b(),layers.kcccFocus=L.layerGroup([[39.069872,-94.552827,"31st & Prospect"],[39.070495,-94.571334,"31st & Troost"]].map(function(a,b){return L.circleMarker([a[0],a[1]],{radius:4,fillColor:colors.green,weight:0,opacity:1,fillOpacity:1}).bindTooltip(a[2],{permanent:!0,direction:0==b?"right":"left"})})),layers.kccc39.bindTooltip("39th Street Corridor",{permanent:!0,direction:"left",offset:L.point([-50,0])}),layers.troostAve.bindTooltip("Troost Ave",{permanent:!0,direction:"left"}),L.tileLayer("https://api.maptiler.com/maps/positron/{z}/{x}/{y}.png?key=lTdR1t9ghN06990FNZFA",{attribution:"<a href=\"https://www.maptiler.com/copyright/\" target=\"_blank\">&copy; MapTiler</a> <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">&copy; OpenStreetMap contributors</a>"}).addTo(map)},j=function(d){f[0]=function(){layers.kcShotSpotterApproxCoverageArea.addTo(map),layers.kcBoundaries.addTo(map),map.flyToBounds(layers.kcBoundaries.getBounds())},g[0]=function(){},f[1]=function(){map.flyToBounds(layers.kcShotSpotterApproxCoverageArea.getBounds(),{padding:[5,5]}),layers.kcShotspotterActivations.setStyle({fillOpacity:0,opacity:0}),d3.select("#legend-3").style("display","none")},g[1]=function(){},f[2]=function(){layers.kcShotspotterActivations.setStyle({fillOpacity:.5,opacity:1}),layers.kcShotspotterActivations.eachLayer(function(a){a.setRadius(2)}),d3.select("#legend-3").style("display","inline-block"),d3.select("#chloropleth-legend").style("display","none")},g[2]=function(){},f[3]=function(){layers.kcShotspotterActivations.eachLayer(function(a){a.setRadius(2*Math.sqrt(a.feature.properties.Activations))}),c()},g[3]=function(){},f[4]=function(){},g[4]=function(){},f[5]=function(){},g[5]=function(){},f[6]=function(){},g[6]=function(){},f[7]=function(){b(),c(),map.flyToBounds(layers.kcShotSpotterApproxCoverageArea.getBounds(),{padding:[5,5]}),layers.kcShotspotterActivations.setStyle({fillOpacity:.5,opacity:1})},g[7]=function(){},f[8]=function(){map.flyToBounds(layers.kcBoundaries.getBounds()),layers.kcShotspotterActivations.setStyle({fillOpacity:0,opacity:0}),a([0,d.maxViolentCrimeRate],[colors.white,colors.black],"VIOLENT CRIME RATE","Violent Crime per 1k People",a=>Math.round(1e3*a))},g[8]=function(){},f[9]=function(){map.flyToBounds([[39.152465,-94.609998],[39.018955,-94.509757]]),a([0,d.maxViolentCrimeRate],[colors.white,colors.black],"VIOLENT CRIME RATE","Violent Crime per 1k People",a=>Math.round(1e3*a))},g[9]=function(){},f[10]=function(){a([0,d.maxViolentCrimeRate],[colors.white,colors.black],"VIOLENT CRIME RATE","Violent Crime per 1k People",a=>Math.round(1e3*a)),layers.kcBGsWithData.eachLayer(function(a){"290950034002"==a.feature.properties.GEOID&&a.setStyle({color:colors.yellow})})},g[10]=function(){},f[11]=function(){b(),map.removeLayer(layers.kcMaxBusLines)},g[11]=function(){},f[12]=function(){layers.kcMaxBusLines.addTo(map),layers.kcShotSpotterApproxCoverageArea.bringToFront(),map.removeLayer(layers.troostAve)},g[12]=function(){},f[13]=function(){map.removeLayer(layers.kcMaxBusLines),layers.troostAve.addTo(map),layers.kcShotSpotterApproxCoverageArea.bringToFront()},g[13]=function(){},f[14]=function(){b()},g[14]=function(){},f[15]=function(){a([0,1],[colors.white,colors.blue],"PCT_BLACK","Percent Black",a=>Math.round(100*a)+"%")},g[15]=function(){},f[16]=function(){map.removeLayer(layers.kcUrbanRenewalAreas),a([0,1],[colors.white,colors.blue],"PCT_BLACK","Percent Black",a=>Math.round(100*a)+"%")},g[16]=function(){},f[17]=function(){b(),layers.kcUrbanRenewalAreas.addTo(map),map.removeLayer(layers.kccc39),map.removeLayer(layers.kcccFocus)},g[17]=function(){},f[18]=function(){layers.kccc39.addTo(map),layers.kcccFocus.addTo(map)},g[18]=function(){},f[19]=function(){b(),layers.kccc39.addTo(map),layers.kcccFocus.addTo(map),layers.troostAve.addTo(map),layers.kcUrbanRenewalAreas.addTo(map)},g[19]=function(){},f[20]=function(){map.removeLayer(layers.kccc39),map.removeLayer(layers.kcccFocus),map.removeLayer(layers.troostAve),map.removeLayer(layers.kcUrbanRenewalAreas),a([-1.5,0,1.5],[colors.blue,colors.white,colors.red],"PCT_CHANGE_RENT","Percent Change in Median Gross Rent",a=>Math.round(100*a)+"%",!0)},g[20]=function(){},f[21]=function(){a([0,25],[colors.white,colors.red],"eviction.rate","Eviction Rate",a=>Math.round(100*a)+"%")},g[21]=function(){},f[22]=function(){a([-.5,0,.5],[colors.red,colors.white,colors.blue],"PCT_CHANGE_BLACK","Percent Change Black Population",a=>Math.round(100*a)+"%",!0)},g[22]=function(){},f[23]=function(){},g[23]=function(){},f[24]=function(){},g[24]=function(){}};// return chart function
return h.activate=function(a){e=a;var b=0>e-d?-1:1,c=d3.range(d+b,e+b,b);c.forEach(function(a){f[a]()}),d=e},h.update=function(a,b){g[a](b)},h};// Load all files, then display
Promise.all([d3.json("data/public/kansas-city-bgs.geojson"),d3.json("data/public/kansas-city-boundaries-mo.geojson"),d3.json("data/public/kansas-city-max-buslines.geojson"),d3.json("data/public/kansas-city-shotspotter-activations-grouped.geojson"),d3.json("data/public/kansas-city-shotspotter-approx-coverage-area.geojson"),d3.json("data/public/kansas-city-urban-renewal-areas.geojson"),d3.json("data/public/troost-ave.geojson"),d3.json("data/public/kccc-39.geojson")]).then(function(a){a={kcBGsWithData:a[0],kcBoundaries:a[1],kcMaxBusLines:a[2],kcShotspotterActivations:a[3],kcShotSpotterApproxCoverageArea:a[4],kcUrbanRenewalAreas:a[5],troostAve:a[6],kccc39:a[7]};// Cast to real
let b=0;return a.kcBGsWithData.features=a.kcBGsWithData.features.map(function(a){return["2013 MEDIAN GROSS RENT","2013 PCT BLACK","2013 PCT HISPANIC","2013 PCT WHITE","2019 MEDIAN GROSS RENT","PCT_BLACK","PCT_HISPANIC","PCT_WHITE","TOTAL"].forEach(function(c){a.properties[c]=parseFloat(a.properties[c]),b=Math.max(b,a.properties["VIOLENT CRIME RATE"])}),a}),a.maxViolentCrimeRate=b,a}).then(function(a){var b=scrollVis();d3.select("#vis").datum(a).call(b);var c=scroller().container(d3.select("#scrolling-vis"));// TODO: remove
c(d3.selectAll(".step")),c.on("active",function(a){d3.selectAll(".step").classed("active",function(b,c){return c===a}).style("opacity",function(b,c){return c===a?1:.1}),b.activate(a)}),c.on("progress",function(a,c){b.update(a,c)})}).catch(function(a){// handle error here
console.log(a)});